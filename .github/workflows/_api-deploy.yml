name: "[Private] Build and Deploy API"

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: 'Environment (dev or prod)'
      artifact_name:
        required: true
        type: string
        description: 'Name of the artifact containing the cdk.out directory'

permissions:
  id-token: write
  contents: read

jobs:
  deploy-api-prereq:
    name: Deploy API Infra to Development
    uses: ./.github/workflows/_cdk-deploy.yml
    with:
      environment: ${{ inputs.environment }}
      stack-pattern: ${{ format('portfolio-stage-{0}/ecommerce-api-prereq', inputs.environment) }}
      artifact_name: ${{ inputs.artifact_name }}

  build-and-publish-api:
    needs: deploy-api-prereq
    name: Build and Publish API
    uses: ./.github/workflows/_app-build-and-publish.yml
    with:
      app_directory: 'api'
      ecs_cluster: 'portfolio-ecommerce-cluster'
      ecs_repository: 'portfolio-ecommerce-service'
      ecs_service: 'portfolio-ecommerce-service'
      environment: ${{ inputs.environment }}

#  deploy-api:
#    name: Deploy API Infra to Development
#    uses: ./.github/workflows/_ecs-deploy.yml
#    needs: build-and-publish-api
#    with:
#      environment: ${{ inputs.environment }}
#      ecs_cluster: 'portfolio-ecommerce-cluster'
#      ecs_repository: 'portfolio-ecommerce-api'
#      ecs_service: 'portfolio-ecommerce-api'
#
